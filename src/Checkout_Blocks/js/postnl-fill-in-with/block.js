import { useEffect, useState } from '@wordpress/element';
import { __ } from '@wordpress/i18n';
import { getSetting } from '@woocommerce/settings';
import { useDispatch } from '@wordpress/data';

export const FillBlock = ( { checkoutExtensionData } ) => {
    const postnlData = getSetting( 'postnl-for-woocommerce-blocks_data', {} );
    const [ showButton, setShowButton ] = useState( false );
    const [ isLoading, setIsLoading ]   = useState(false);
    const { setBillingAddress, setShippingAddress } = useDispatch('wc/store/cart');

	useEffect( () => {
		if ( postnlSettings?.is_enabled_for_checkout ) {
			setShowButton( true );
			prefillCheckoutFields();
		}
	}, [ postnlData ] );

	const handleButtonClick = async ( event ) => {
        event.preventDefault();
        if ( isLoading ) return;

        setIsLoading( true );

        try {
            const response = await fetch( postnlSettings.restUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify( {
                    nonce: postnlSettings.nonce,
                } ),
            } );

            const data = await response.json();

            if ( data.success && data.data.redirect_uri ) {
                window.location.href = data.data.redirect_uri;
            } else {
                alert( __( 'Unable to connect to PostNL. Please try again later.', 'postnl-for-woocommerce' ) );
            }
        } catch ( error ) {
            alert( __( 'An error occurred. Please try again.', 'postnl-for-woocommerce' ) );
        } finally {
            setIsLoading( false );
        }
    };

	const prefillCheckoutFields = async () => {
		try {
			const response = await fetch( postnlSettings.ajaxUrl, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
				},
				body: new URLSearchParams( {
					action: 'get_postnl_user_info',
					nonce: postnlSettings.ajaxNonce,
				} ),
			} );

			const data = await response.json();
			if ( data.success && data.data ) {
				const { person, primaryAddress } = data.data;
				// Update WooCommerce blocks billing address
				const addressFields = {
                    first_name: person.givenName || '',
                    last_name: person.familyName || '',
                    email: person.email || '',
                    address_1: primaryAddress.streetName || '',
                    address_2: primaryAddress.houseNumberAddition || '',
                    city: primaryAddress.cityName || '',
					house_number: primaryAddress.houseNumber || '',
                    postcode: primaryAddress.postalCode || '',
                    country: primaryAddress.countryName || 'NL', // Default to NL for PostNL.
                };

                setShippingAddress(addressFields);
				setBillingAddress(addressFields);

			} else {
				console.error( 'Failed to retrieve PostNL user data:', data.message );
			}
		} catch ( err ) {
			console.error( 'Error fetching PostNL user data:', err );
			alert( __( 'Failed to retrieve PostNL address. Please try again.', 'postnl-for-woocommerce' ) );
		}
	};

    if ( ! showButton ) {
        return null;
    }

	const title       = __( 'Fill in with PostNL', 'postnl-for-woocommerce' );
	const description = __( 'Your name and address are automatically filled in via your PostNL account. That saves you from having to fill in the form!', 'postnl-for-woocommerce' );

	return (
		<div className="button--postnl-container">
			<a
				type="button"
				id="postnl-login-button"
				aria-label={ title }
				href="#"
                onClick={ handleButtonClick }
                className={ isLoading ? 'disabled' : '' }
			>
				<span id="postnl-login-button__text">
					<span id="postnl-login-button__first-text">
						<svg id="postnl-logo" role="img" aria-label="PostNL" focusable="false" viewBox="0 0 88 88" fill="none" xmlns="http://www.w3.org/2000/svg" width="40" height="40">
							<path d="M29.9894 39.3958C26.5744 39.3958 23.8275 41.2897 23.8275 45.5547C23.8275 49.7243 26.5744 51.7137 29.9894 51.7137C33.3925 51.7137 36.1454 49.7243 36.1454 45.5547C36.1454 41.2897 33.3925 39.3958 29.9894 39.3958ZM29.9894 48.7848C28.4623 48.7848 27.32 47.6246 27.32 45.5547C27.32 43.3029 28.4623 42.3187 29.9894 42.3187C31.5075 42.3187 32.6528 43.3029 32.6528 45.5547C32.6528 47.6246 31.5075 48.7848 29.9894 48.7848ZM52.1825 39.5032C52.1825 39.5658 52.2332 39.6165 52.2959 39.6165H54.8877C55.0935 39.6165 55.2605 39.7865 55.2605 39.9863V42.2292C55.2605 42.2948 55.2098 42.3455 55.1472 42.3455H52.2959C52.2332 42.3455 52.1825 42.3962 52.1825 42.4589V46.8134C52.1825 48.4836 52.8148 48.9787 53.8707 48.9787C54.3658 48.9787 55.1442 48.6745 55.2575 48.6745C55.3202 48.6745 55.3739 48.7252 55.3739 48.7878V50.9353C55.3739 51.0963 55.2814 51.2097 55.18 51.2633C54.7088 51.5169 53.9184 51.6898 52.7492 51.6898C50.7062 51.6898 48.8093 50.6609 48.8093 47.3771V39.8044C48.8093 39.1333 49.0717 38.4951 49.4863 38.0417C50.0381 37.4333 51.8127 36.2939 52.0424 36.2939C52.1408 36.2939 52.1825 36.3238 52.1825 36.4162V39.5032ZM10.9757 39.9983C10.9757 39.7865 11.1457 39.6195 11.3574 39.6195H15.8492C20.2603 39.6195 22.545 42.268 22.545 45.6949C22.545 49.1249 19.9889 51.499 15.7776 51.499H14.4653C14.4026 51.499 14.3489 51.5497 14.3489 51.6153V57.1718C14.3489 57.2642 14.3102 57.2941 14.2088 57.2941C13.9791 57.2941 12.2045 56.1547 11.6527 55.5463C11.2381 55.0899 10.9757 54.4517 10.9757 53.7836V39.9983ZM19.2135 45.5219C19.2135 44.0635 18.271 42.6975 15.7806 42.6975H14.4593C14.3967 42.6975 14.346 42.7482 14.346 42.8138V48.2957C14.346 48.3583 14.3967 48.412 14.4593 48.412H15.8462C18.8138 48.412 19.2135 46.3511 19.2135 45.5219ZM47.0734 47.8364C47.0734 50.3387 45.275 51.7137 41.7675 51.7137C39.7602 51.7137 37.6396 51.0098 37.6217 51.0039C37.4637 50.9442 37.3593 50.801 37.3593 50.637V48.3047C37.3593 48.2271 37.4249 48.1675 37.5054 48.1675C37.5174 48.1675 37.5502 48.1734 37.5532 48.1764C38.3018 48.418 40.7296 49.0205 42.021 49.0205C42.7845 49.0205 43.1842 48.9071 43.4407 48.6506C43.6167 48.4747 43.6972 48.2868 43.6972 48.0601C43.6972 47.2966 42.7398 47.0848 41.8122 46.882C41.6959 46.8581 41.7466 46.8701 41.4334 46.7955C39.4023 46.3153 37.2609 45.8202 37.2609 43.2045C37.2609 42.0443 37.747 41.0809 38.6567 40.4128C39.5634 39.7447 40.8727 39.3958 42.4415 39.3958C43.8523 39.3958 45.5255 39.8611 46.0862 40.04C46.2622 40.0967 46.3636 40.2518 46.3636 40.4099V42.7362C46.3576 42.8436 46.2443 42.8943 46.1667 42.8645C44.5592 42.262 43.0888 42.0503 42.0329 42.0503C41.1948 42.0503 40.652 42.4141 40.652 42.9778C40.652 43.628 41.4454 43.804 42.4505 44.0307C42.5728 44.0575 43.1216 44.1828 43.2647 44.2126C44.0879 44.3945 44.9379 44.5795 45.6359 45.0358C46.6022 45.6681 47.0734 46.5837 47.0734 47.8364ZM65.258 51.4572C65.2193 51.4572 65.1864 51.4244 65.1864 51.3856V44.308C65.1864 42.7362 64.6526 42.0652 63.3999 42.0652C62.9525 42.0652 62.4127 42.2322 61.8758 42.5364C61.3419 42.8466 60.9244 43.1031 60.7753 43.1926C60.7335 43.2194 60.6888 43.291 60.6888 43.3477V51.3886C60.6888 51.4274 60.656 51.4602 60.6172 51.4602H57.4617C57.4229 51.4602 57.3871 51.4274 57.3871 51.3886V40.0012C57.3871 39.8163 57.5392 39.6642 57.7271 39.6642H60.6202C60.6589 39.6642 60.6947 39.697 60.6947 39.7358V40.6306C60.6947 40.6842 60.7395 40.729 60.7932 40.729C60.814 40.729 60.8409 40.7171 60.8498 40.7111L60.9453 40.6395C61.2972 40.3681 61.84 40.0609 62.2039 39.9207C62.9943 39.6195 63.8473 39.4435 64.5392 39.4435C67.1191 39.4435 68.4822 40.9258 68.4822 43.7264V51.3826C68.4822 51.4244 68.4494 51.4542 68.4076 51.4542H65.258V51.4572ZM71.0859 51.4572C71.0471 51.4572 71.0143 51.4244 71.0143 51.3856V33.9467C71.0143 33.884 71.0263 33.8661 71.1128 33.8661C71.3096 33.8661 73.0693 34.9727 73.639 35.599C74.0625 36.0643 74.3041 36.6966 74.3041 37.3348V51.3856C74.3041 51.4244 74.2713 51.4572 74.2325 51.4572H71.0859V51.4572ZM29.9864 21.1456C29.9268 21.1456 29.8701 21.1635 29.8015 21.2052C29.2706 21.6049 28.8024 22.0672 28.3967 22.5862C28.2774 22.7204 28.2774 22.8755 28.4027 23.0365C28.7874 23.5346 29.2289 23.979 29.712 24.3578C29.8015 24.4294 29.891 24.4622 29.9834 24.4622C30.0759 24.4622 30.1654 24.4264 30.2549 24.3548C30.738 23.976 31.1794 23.5316 31.5642 23.0365C31.6895 22.8755 31.6895 22.7204 31.5642 22.5772C31.1675 22.0642 30.6993 21.6019 30.1803 21.2112C30.1057 21.1635 30.0491 21.1456 29.9864 21.1456ZM29.9864 25.4196C29.7329 25.4196 29.4645 25.4255 29.1871 25.4375C29.0887 25.4375 28.9992 25.4733 28.9306 25.5448C28.8322 25.6433 28.7934 25.8013 28.7934 25.9057C28.8024 26.4515 28.8382 29.3327 28.862 31.1669C28.8739 32.0528 28.8799 32.694 28.8829 32.7149C28.8829 32.8461 28.9783 33.1205 29.2736 33.1205H30.7022C30.914 33.1205 31.0601 32.9714 31.09 32.7328C31.09 32.7268 31.09 32.7208 31.09 32.7149C31.09 32.6701 31.1198 30.2215 31.1765 25.9952V25.9117C31.1794 25.8312 31.1526 25.6582 31.0423 25.5478C30.9737 25.4762 30.8842 25.4434 30.7798 25.4434C30.5114 25.4285 30.2429 25.4196 29.9864 25.4196ZM33.6102 25.8103C33.2821 25.8103 33.0137 25.9922 32.8735 26.3054C32.4619 27.221 32.1637 28.0561 31.8744 29.0941C31.8416 29.2164 31.8535 29.3178 31.9102 29.3923C31.9489 29.443 32.0265 29.5027 32.1816 29.5027H33.2971C33.5506 29.5027 33.643 29.3685 33.6788 29.2581C33.8608 28.6377 33.992 28.2768 34.2246 27.7639C34.2276 27.7579 34.2455 27.7251 34.3141 27.7251C34.3409 27.7251 34.3678 27.7281 34.3946 27.737L34.9613 27.9249C35.0269 27.9488 35.0687 28.0054 35.0896 28.0502C35.1313 28.1367 35.1373 28.253 35.1075 28.3395C35.1015 28.3574 33.9622 31.5427 33.6222 32.6045C33.5715 32.7686 33.5774 32.8968 33.646 32.9923C33.7086 33.0788 33.816 33.1235 33.9651 33.1235H35.3461C35.5727 33.1235 35.7219 33.034 35.7875 32.8521C35.8382 32.7149 35.9098 32.515 35.9933 32.2794L36.0261 32.19C36.4407 31.0327 37.07 29.279 37.2042 28.7809C37.4309 27.9368 37.4935 27.0122 36.2557 26.5529C35.862 26.4068 35.4892 26.2815 35.1462 26.1771C34.7108 26.0429 34.2902 25.9445 33.9204 25.858L33.8757 25.8461C33.7743 25.8192 33.6908 25.8103 33.6102 25.8103ZM26.3626 25.8103C26.2821 25.8103 26.1986 25.8192 26.1181 25.8401L26.0614 25.852C25.6916 25.9385 25.274 26.037 24.8386 26.1712C24.4985 26.2756 24.1257 26.4008 23.729 26.547C22.4883 27.0063 22.5539 27.9309 22.7806 28.7749C22.9088 29.2551 23.4934 30.8985 23.9885 32.2735C24.075 32.5091 24.1436 32.7089 24.1943 32.8461C24.2599 33.028 24.4091 33.1175 24.6357 33.1175H26.0167C26.2016 33.1175 26.2911 33.0459 26.3358 32.9863C26.4044 32.8938 26.4104 32.7656 26.3597 32.6015C26.0226 31.5547 24.8833 28.3663 24.8714 28.3365C24.8415 28.25 24.8475 28.1367 24.8893 28.0472C24.9101 28.0025 24.9489 27.9458 25.0205 27.9219L25.5902 27.734C25.611 27.7281 25.6379 27.7251 25.6647 27.7251C25.7214 27.7251 25.7482 27.7489 25.7542 27.7639C25.9898 28.2888 26.124 28.6527 26.3 29.2581C26.3328 29.3714 26.4253 29.5027 26.6788 29.5027H27.7972C27.9195 29.5027 28.012 29.4669 28.0687 29.3923C28.1253 29.3178 28.1373 29.2193 28.1015 29.097C27.8092 28.0532 27.5109 27.218 27.1023 26.3054C27.0337 26.1563 26.8279 25.8103 26.3626 25.8103ZM35.0657 34.1793H24.9221C24.5671 34.1793 24.2659 34.4776 24.2659 34.8325V36.109C24.2659 36.5087 24.4359 36.7025 24.7908 36.7025H35.1999C35.5519 36.7025 35.7219 36.5087 35.7219 36.109V34.8325C35.7219 34.4776 35.4206 34.1793 35.0657 34.1793ZM83.9139 44.0486C83.9019 36.9262 70.5222 24.5904 56.2657 16.7314C39.8199 7.66149 21.1044 2.31676 14.9395 5.71388C7.9126 9.5912 4.06214 28.9449 4.05915 44.0486C4.06214 59.2745 7.68891 78.3807 14.9395 82.3803C21.51 86.0011 39.4113 80.6563 56.2657 71.3657C70.7459 63.3814 83.9019 51.5169 83.9139 44.0486ZM19.8756 1.22217C30.2549 1.22217 46.8826 7.78377 57.9389 13.8801C64.2648 17.3667 71.4438 22.4549 76.9973 27.6326C82.3271 32.5986 87.3557 38.7814 87.3647 44.0486C87.3557 49.0085 83.3293 54.8275 76.8482 60.7687C71.3454 65.8092 64.1992 70.7662 57.9418 74.217C47.2613 80.1046 30.9826 86.9823 20.2514 86.9823C17.3345 86.9823 14.9425 86.4783 13.135 85.4821C8.38384 82.8634 5.33866 75.8067 3.54019 68.8932C1.6075 61.4756 0.614311 52.5548 0.611328 44.0515C0.611328 35.7302 1.68504 26.7886 3.5551 19.5171C5.83377 10.6619 9.14738 4.81912 13.135 2.618C14.8082 1.69043 17.078 1.22217 19.8756 1.22217Z"></path>
						</svg>
					</span>
					<span id="postnl-login-button__second-text">
						{ title }
					</span>
				</span>
			</a>
			<div className="col-12 hidden-md">
				<p className="postnl-fill-in-with__description">
					{ description }
				</p>
			</div>
		</div>
	);
};
